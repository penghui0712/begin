/**
 * Created by lwb on 2016/9/19.
 */
var token;
var sellId;     //å–å®¶idï¼Œç›¸å½“äºuserId
var author;     //å–å®¶åç§°ï¼Œç›¸å½“äºuserName
var friendList; //åˆ†ç»„åˆ—è¡¨
var toUserId;   //å‘é€ç›®æ ‡ï¼Œç›¸å½“äºtargetId
var groupId;    //ç¾¤id
var groupList; //ç¾¤ç»„åˆ—è¡¨
var map = {}; // Map map = new HashMap();
var imIndex;  //ç”¨æ¥åˆ¤æ–­ç‚¹å‡»çš„æ˜¯å¥½å‹è¿˜æ˜¯ç¾¤ç»„
var friendId; //ç‚¹å‡»åŠ ä¸ºå¥½å‹æŒ‰é’®è·å–æ‰€ç‚¹çš„å¥½å‹id
//var addFriend; //æœ€è¿‘è”ç³»äººç•Œé¢åŠ ä¸ºå¥½å‹æ—¶è·å–div
var text;
var groupingId; //å¥½å‹åˆ†ç»„çš„id
$(function(){
	
  //æ ¹æ®sellIdæŸ¥è¯¢shopId
  var searchShopId = function(datas){
	  	var result = datas.data;
	  	author = result.author;
  }
	  
  sellId = 12;//Utils.getUrlParam("sellId");// Utils.getLoginUser.userID;
  var data = {"sellId":sellId};
  doPost("/huoban-sales/http/sales/userlogin/getSellInfo.do",data,searchShopId);
  
  $('#im-info').perfectScrollbar();
  $('#friend-list').perfectScrollbar();
  $('#chat-list').perfectScrollbar();
  $('#record-list').perfectScrollbar();

  laydate({
    elem: '#record-start-date',
    istime: false, //æ˜¯å¦å¼€å¯æ—¶é—´é€‰æ‹©
    isclear: false, //æ˜¯å¦æ˜¾ç¤ºæ¸…ç©º
    istoday: false //æ˜¯å¦æ˜¾ç¤ºä»Šå¤©

  })

  laydate({
    elem: '#record-end-date',
    istime: false, //æ˜¯å¦å¼€å¯æ—¶é—´é€‰æ‹©
    isclear: false, //æ˜¯å¦æ˜¾ç¤ºæ¸…ç©º
    istoday: false //æ˜¯å¦æ˜¾ç¤ºä»Šå¤©
  })

  $("#left-date-btn").click(function(){
    $("#record-start-date").click();
  })
  $("#right-date-btn").click(function(){
    $("#record-end-date").click();
  })

  $('.collapse').on('show.bs.collapse', function () {
      var index=$('.collapse').index($(this));
      $(".arrow-img").eq(index).attr("src","../images/im_arrow_up.png");
  })
  $('.collapse').on('hide.bs.collapse', function () {
    var index=$('.collapse').index($(this));
    $(".arrow-img").eq(index).attr("src","../images/im_arrow_down.png");
  })

  $(".record-btn").click(function(){
    if(!$(this).hasClass("active")){
      changeStyle(".record-btn",$(this));
    }
  })


  function changeStyle(objClass,obj){
      $(objClass).each(function(index,element){
        if($(element).hasClass("active")){
          $(element).find("img").attr("src",$(element).find("img").attr("src").replace("_checked.png",".png"));
          $(element).removeClass("active");
        }
      });
      $(obj).find("img").attr("src",$(obj).find("img").attr("src").replace(".png","_checked.png"));
      $(obj).addClass("active");
  }


  $("#chat-record").click(function(){

    if($(this).hasClass("active")){
      $("#chat-view").animate({width:"875px"});
      $(this).removeClass("active")
    }else{
      $("#chat-view").animate({width:"524px"});
      $(this).addClass("active");
    }
/*    $('#friend-list').perfectScrollbar("update");
    $('#chat-list').perfectScrollbar("update");
    $('#record-list').perfectScrollbar("update");*/

  })


  //å·¦ä¾§menu
  $(".menu-btn").click(function(){
    if(!$(this).hasClass("active")){
      changeStyle(".menu-btn",$(this));

      changeLeftTab($(".menu-btn").index($(this)));
    }
  });


  
	//åˆå§‹åŒ–SDK
	RongIMClient.init("uwd1c0sxdued1");
	
	//è·å–token
	var webSuccess = function(datas){
		var result = datas.data.result;
		var obj = eval('('+result+')');//å°†JSONå­—ç¬¦ä¸²è½¬æ¢ä¸ºJSONå¯¹è±¡
		token = obj.token;
	}
	var im_type = 0;
	var data = {"userId":sellId,"userName":author,"im_type":im_type};
	doPost("/huoban-sales/http/sales/userlogin/salesImWeb.do",data,webSuccess);

	
	// è®¾ç½®è¿æ¥ç›‘å¬çŠ¶æ€ ï¼ˆ status æ ‡è¯†å½“å‰è¿æ¥çŠ¶æ€ï¼‰
	// è¿æ¥çŠ¶æ€ç›‘å¬å™¨
	 RongIMClient.setConnectionStatusListener({
		    onChanged: function (status) {
		        switch (status) {
		            //é“¾æ¥æˆåŠŸ
		            case RongIMLib.ConnectionStatus.CONNECTED:
		                console.log('é“¾æ¥æˆåŠŸ');
		                break;
		            //æ­£åœ¨é“¾æ¥
		            case RongIMLib.ConnectionStatus.CONNECTING:
		                console.log('æ­£åœ¨é“¾æ¥');
		                break;
		            //é‡æ–°é“¾æ¥
		            case RongIMLib.ConnectionStatus.DISCONNECTED:
		                console.log('æ–­å¼€è¿æ¥');
		                break;
		            //å…¶ä»–è®¾å¤‡ç™»å½•
		            case RongIMLib.ConnectionStatus.KICKED_OFFLINE_BY_OTHER_CLIENT:
		                console.log('å…¶ä»–è®¾å¤‡ç™»å½•');
		                break;
		              //ç½‘ç»œä¸å¯ç”¨
		            case RongIMLib.ConnectionStatus.NETWORK_UNAVAILABLE:
		              console.log('ç½‘ç»œä¸å¯ç”¨');
		              break;
		            }
		   }});
	 

	 //æ¶ˆæ¯ç›‘å¬å™¨
	 RongIMClient.setOnReceiveMessageListener({
		    // æ¥æ”¶åˆ°çš„æ¶ˆæ¯
		    onReceived: function (message) {
		        // åˆ¤æ–­æ¶ˆæ¯ç±»å‹
		        switch(message.messageType){
		            case RongIMClient.MessageType.TextMessage: //æ–‡æœ¬æ¶ˆæ¯
		                // å‘é€çš„æ¶ˆæ¯å†…å®¹å°†ä¼šè¢«æ‰“å°
		                console.log(message.content.content);
		                var content = message.content.content;
		                var targetId = message.targetId;
			       		var userContent = '<div class="other-chat">'+
						                  '<img class="user-icon" src="../images/im-user-icon.png">'+
					                      '<span class="left-arrow"></span>'+
					                      '<span class="left-arrow-bg"></span>'+
					                      '<div class="other-chat-info">'+
					                      '<pre>'+content+'</pre>'+
					                      '</div></div>';
			       		if((groupId!=undefined && groupId!=null) || (toUserId!=undefined && toUserId!=null)){
			       			if(groupId==targetId || toUserId==targetId){
			       				$("#chat-list").append(userContent);
			       			}
			       		}
		                break;
		            case RongIMClient.MessageType.VoiceMessage:  //å£°éŸ³æ¶ˆæ¯
		                // å¯¹å£°éŸ³è¿›è¡Œé¢„åŠ è½½                
		                // message.content.content æ ¼å¼ä¸º AMR æ ¼å¼çš„ base64 ç 
		                //RongIMLib.RongIMVoice.preLoaded(message.content.content);
		                break;
		            case RongIMClient.MessageType.ImageMessage:  //å›¾ç‰‡æ¶ˆæ¯
		            	var targetId = message.targetId;
		            	var imageUri = message.content.imageUri;
		            	var image = '<div class="other-chat">'+
		            	              '<img class="user-icon" src="../images/im-user-icon.png">'+
		            	              '<span class="left-arrow"></span>'+
		            	              '<span class="left-arrow-bg"></span>'+
		            	              '<div class="other-chat-info">'+
		            	              '<pre><img class="record-img" src="'+imageUri+'"></pre>'+
		            	              '</div></div>';
			       		if((groupId!=undefined & groupId!=null) || (toUserId!=undefined & toUserId!=null)){
			       			if(groupId==targetId || toUserId==targetId){
			       				$("#chat-list").append(image);
			       			}
			       		}
		                break;
		            case RongIMClient.MessageType.DiscussionNotificationMessage: //è®¨è®ºç»„é€šçŸ¥æ¶ˆæ¯

		                break;
		            case RongIMClient.MessageType.LocationMessage:  //æœ¬åœ°æ¶ˆæ¯

		                break;
		            case RongIMClient.MessageType.RichContentMessage: //

		                break;
		            case RongIMClient.MessageType.InformationNotificationMessage:  //ä¿¡æ¯é€šçŸ¥æ¶ˆæ¯

		                break;
		            case RongIMClient.MessageType.ContactNotificationMessage:

		                break;
		            case RongIMClient.MessageType.ProfileNotificationMessage:

		                break;
		            case RongIMClient.MessageType.CommandNotificationMessage: //å‘½ä»¤é€šçŸ¥æ¶ˆæ¯

		                break;
		            case RongIMClient.MessageType.CommandMessage: //å‘½ä»¤æ¶ˆæ¯

		                break;
		            case RongIMClient.MessageType.UnknownMessage: //æœªçŸ¥æ¶ˆæ¯

		                break;
		            default:
		                // è‡ªå®šä¹‰æ¶ˆæ¯

		        }
		    }
		});
	 
	// è¿æ¥èäº‘æœåŠ¡å™¨
   RongIMClient.connect(token, {
     onSuccess: function(userId) {
       console.log("Login successfully." + userId);
     },
     onTokenIncorrect: function() {
       console.log('tokenæ— æ•ˆ');
     },
     onError:function(errorCode){
           var info = '';
           switch (errorCode) {
             case RongIMLib.ErrorCode.TIMEOUT:
               info = 'è¶…æ—¶';
               break;
             case RongIMLib.ErrorCode.UNKNOWN_ERROR:
               info = 'æœªçŸ¥é”™è¯¯';
               break;
             case RongIMLib.ErrorCode.UNACCEPTABLE_PaROTOCOL_VERSION:
               info = 'ä¸å¯æ¥å—çš„åè®®ç‰ˆæœ¬';
               break;
             case RongIMLib.ErrorCode.IDENTIFIER_REJECTED:
               info = 'appkeyä¸æ­£ç¡®';
               break;
             case RongIMLib.ErrorCode.SERVER_UNAVAILABLE:
               info = 'æœåŠ¡å™¨ä¸å¯ç”¨';
               break;
           }
           console.log(errorCode);
         }
   });

   /**
    * targetId:ç›®æ ‡Id
    */
   function setMap(targetId){
	   if(targetId!=undefined){
		   map[targetId] = $("#chat-list").html(); //å°†æ•°æ®å­˜å…¥map
	   }
   }
   /**
    * targetId:ç›®æ ‡Id
    **/
   function getMap(targetId){
	   var record = map[targetId]; //æ ¹æ®keyè·å–valueçš„å€¼
	   if(record!=undefined){
		   $("#chat-list").html(record);//å°†å€¼å†™åœ¨åˆ—è¡¨ä¸Š
	   }else{
		   $("#chat-list").html('');
	   }
   }
   
   //æŸ¥è¯¢åˆ†ç»„å¥½å‹æˆåŠŸå›è°ƒå‡½æ•°
   var groupingSuccess = function(datas){
	   var result = datas.data;
	   if(result!=null){
		   var length = result.length;
	   }
	   $('#'+groupingId).empty();
	   if(length!=null){
		  for(var i=0;i<result.length;i++){
			  var author = result[i].author;
			  var id = result[i].id;
			  var content = '<div class="friend-item">'+
			                '<div class="item" id="'+id+'">'+
			                '<img class="friend-icon" src="../images/im-user-icon.png" class="friend-icon">'+
			                '<div class="item-info">'+
			                '<span class="name">'+author+'</span></div></div>'+
			                '<div class="line"></div></div>';
			  $('#'+groupingId).append(content);
		  } 
	   }
	   //é€‰æ‹©å¥½å‹
	   $(".item").click(function(){
	     if(!$(this).hasClass("active")){
	       $(this).addClass("active");
	    	   toUserId = $(this).attr("id");//get new user id
	    	   getMap(toUserId);
	           
	       $(".item").not($(this)).removeClass("active");
	     }
	   })
   }
   
   var friendListSuccess = function(datas){
	   //åˆ†ç»„åˆ—è¡¨
	   friendList = datas.data;
	   $("#im_group").hide();
	   $("#im_friend").show();
       $("#info-list").hide();
       $("#friend-list").show();
	   $("#friend-list").empty();
	   $("#chat-list").empty();
	   $("#chat-view").show();
	   $("#message-list").hide();
	   if(friendList==null){
		   alert("æš‚æ— å¥½å‹");
	   }
	   var first = '<div class="group-list panel-group" id="accordion"></div>';
	   $("#friend-list").append(first);
	   for(var i=0;i<friendList.length;i++){
		   var groupId = friendList[i].groupId;
		   var groupName = friendList[i].groupName;
		   if(groupName==null){
			   groupName="";
		   }
		   var content = '<div class="group-view">'+
			             '<div class="group-title-view">'+
		                 '<span class="title" data-toggle="collapse" data-parent="#accordion" href="#group'+groupId+'">'+groupName+'()<img class="arrow-img" src="../images/im_arrow_down.png"></span>'+
		                 '</div>'+
		                 '<div class="group-info panel-collapse collapse" id="group'+groupId+'">'+
		                 '</div></div>';
		   $("#accordion").append(content);
	   }
	   
	   
	   $(".group-view").click(function(){
		   groupingId = $(this).children()[1].id;
		   var gid = groupingId.substring(5);
		   text = $(this).children()[0].children[0];
		   var data = {"gid":gid,"userId":sellId};
		   doPost("/huoban-sales/http/sales/userlogin/myGroup_Friend.do",data,groupingSuccess);
	   });
//	   for(var i=0;i<friendList.length;i++){
//		   var author = friendList[i].author;
//		   if(author==null){
//			   author = "";
//		   }
//		   var id = friendList[i].id;
//		   var content = '<div class="friend-item"><div class="item" id="'+id+'">'+
//		                 '<img class="friend-icon" src="../images/im-user-icon.png" class="friend-icon">'+
//		                 '<div class="item-info"><span class="name">'+author+'</span>'+
//		                 '<span class="desc" style="display:none;">å“ˆå–½ï¼ï¼</span></div></div><div class="line"></div></div>';
//           $("#friend-list").append(content);
//	   }

	   
   }
   
   
   //æŸ¥è¯¢ç¾¤æˆåŠŸå›è°ƒå‡½æ•°
   var contactsSuccess = function(datas){
	   var result = datas.data;
	   //è·å–ç¾¤åˆ—è¡¨
	   groupList = result.lig;
       $("#im_group").show();
	   $("#im_friend").hide();
	   $("#im-info").empty();
	   $("#chat-list").empty;
	   $("#chat-view").show();
	   $("#message-list").hide();
	   if(groupList==null){
		   alert("æš‚æ— ç¾¤ç»„");
	   }
	   for(var i=0;i<groupList.length;i++){
		   var groupName = groupList[i].groupName;
		   var id = groupList[i].groupId;
		   var lsi = groupList[i].lsi;
		   var length = lsi.length;
		   var group = '<div class="friend-item">'+
			           '<div class="item" id="'+id+'">'+
			           '<img class="friend-icon" src="../images/im-user-icon.png" class="friend-icon">'+
			           '<div class="item-info">'+
			           '<span class="name">'+groupName+'('+length+')</span>'+
			           '<span class="desc" style="display:none;">å“ˆå–½ï¼ï¼</span>'+
			           '</div></div>'+
			           '<div class="line"></div></div>';
		   $("#im-info").append(group); 
	   }
	   
	   //é€‰æ‹©å¥½å‹
	   $(".item").click(function(){
	     if(!$(this).hasClass("active")){
	       $(this).addClass("active");	
	    	   //2.å–å½“å‰é€‰ä¸­toUserId,å¹¶å–å½“å‰toUserIdçš„å†å²è®°å½•æ˜¾ç¤ºåœ¨å¯¹è¯$("#chat-list")
	    	   groupId = $(this).attr("id");//get new user id
	    	   getMap(groupId);
	       $(".item").not($(this)).removeClass("active");
	     }
	   })
	   

   }
   
   //æ–°å¥½å‹åˆ—è¡¨ä¸­æ·»åŠ å¥½å‹æˆåŠŸå›è°ƒå‡½æ•°
   var addInfoSuccess = function(datas){
	   alert(datas.message);
//	   var id = addFriend.children()[1].id;
//	   var last_time = addFriend.children()[0].innerText;
//	   var info = addFriend.children()[1].children[1].children[0].innerText;
//	   var arrayInfo = info.split("(");
//	   var author = arrayInfo[0];
//	   var authorMobile = arrayInfo[1].substring(0,11);
//	   addFriend.remove();
//	   addSuccess(last_time,author,authorMobile,id);
	   changeLeftTab(0);
   }
   //ä¿¡æ¯åˆ—è¡¨å¥½å‹åˆ†ç»„æŸ¥è¯¢æˆåŠŸ
   var infoListSuccess = function(datas){
	   var result = datas.data;
	   $(".select").empty();
	   friendGroup(result);
	   $(".done").click(function(){
			 var option = $($(this).parent().prev().prev().children()[1]).val();
			 if(option==null || option==undefined){
				 option=0;
			 }
			 var remark = $($(this).parent().prev().children()[1]).val();
			 var friendId = $($(this).parent().parent().parent()).attr("id");
			 //addFriend = $(this).parent().parent().parent().parent();
			 var data = {"userId":sellId,"groupId":option,"label":remark,"friendId":friendId};
		     doPost("/huoban-sales/http/sales/userlogin/addFriend.do",data,addInfoSuccess);
	   });
   }
   
   //å°è£…å·²ç»åŠ ä¸ºå¥½å‹çš„æ˜¾ç¤ºåˆ—è¡¨
   function addSuccess(last_time,author,authorMobile,id){
	   var thd = '<div class="message-item">'+
		     	 '<span class="tips">'+last_time+'</span>'+
		     	 '<div class="message-type-1" id="'+id+'">'+
		     	 '<img class="user-icon" src="../images/order_test.png">'+
		     	 '<div class="user-info">'+
		     	 '<span class="tips">'+author+' ('+authorMobile+')å·²æˆåŠŸæ·»åŠ æ‚¨ä¸ºä¼™ä¼´ï¼</span>'+
		     	 '<div class="cell mt10"><span class="sub-tips">ç”¨æˆ·ä¿¡ç”¨:</span><img class="star-img" src="../images/star.png"><img class="star-img" src="../images/star.png"><img class="star-img" src="../images/star.png"><img class="star-img" src="../images/star.png"><img class="star-img" src="../images/half_star.png"><span class="score-tips">4.9åˆ†</span></div>'+
		     	 '<div class="cell"><span class="sub-tips">å•†å®¶ç­‰çº§:</span><img class="shop-level-icon" src="../images/shop_level_icon.png"><span class="level-tips"> 5 Lev</span></div>'+
		     	 '</div><a class="tools-btn b6BC2EF">ä¼šè¯çª—å£</a></div></div>';
      $("#message-grade").append(thd);
   }
   
   //æ–°çš„å¥½å‹åˆ—è¡¨
   var newFriendListSuccess = function(datas){
	   var result = datas.data;
	   var date = (new Date()).Format("yyyy-MM-dd");
	   $("#im_group").hide();
	   $("#im_friend").show();
       $("#friend-list").hide();
       $("#info-list").show();
       $("#message-verify").empty();
	   $("#message-grade").empty();
	   $("#chat-view").hide();
	   $("#message-list").show();
	   var head = '<div class="message-item">'+
	              '<img class="message-icon" src="../images/head_new.png">'+
	              '<div class="detail-view">'+
	              '<span class="title">ä¼™ä¼´éªŒè¯æ¶ˆæ¯</span>'+
	              '<span class="desc">æœ€æ–°ï¼š'+date+'</span></div></div>';
	   $("#message-verify").append(head);
	   for(var i=0;i<result.length;i++){
		   var author = result[i].author;
		   var authorMobile = result[i].authorMobile;
		   var last_time = result[i].last_time;
		   var isFriend = result[i].isFriend;
		   var id = result[i].id;
		   var content = '<div class="message-item">'+
		                 '<img class="message-icon" src="../images/order_test.png">'+
		                 '<div class="detail-view">'+
		                 '<span class="title">'+author+'</span>'+
		                 '<span class="desc"></span></div></div>';
		   $("#message-verify").append(content);
		   if(isFriend==2){ //åˆ«äººç”³è¯·åŠ æˆ‘ä¸ºå¥½å‹
			   var first = '<div class="message-item">'+
			               '<span class="tips">'+last_time+'</span>'+
			               '<div class="message-type-1" id="'+id+'">'+
			               '<img class="user-icon" src="../images/order_test.png">'+
			               '<div class="user-info">'+
			               '<span class="tips">'+author+'('+authorMobile+')ç”³è¯·åŠ æ‚¨ä¸ºä¼™ä¼´ï¼</span>'+
			               '<div class="cell mt10"><span class="sub-tips">ç”¨æˆ·ä¿¡ç”¨:</span><img class="star-img" src="../images/star.png"><img class="star-img" src="../images/star.png"><img class="star-img" src="../images/star.png"><img class="star-img" src="../images/star.png"><img class="star-img" src="../images/half_star.png"><span class="score-tips">4.9åˆ†</span></div>'+
			               '<div class="cell"><span class="sub-tips">å•†å®¶ç­‰çº§:</span><img class="shop-level-icon" src="../images/shop_level_icon.png"><span class="level-tips"> 5 Lev</span></div>'+
			               '</div><a class="add-friend tools-btn b7ED321">åŠ ä¸ºä¼™ä¼´</a>'+
			               '<div class="add-info-view"><div class="item-tools mt20"><span class="ttips">åˆ†ç»„ï¼š</span>'+
			               '<select class="select"><option>sh</option></select><a id="add-group-btn" class="add-group">æ–°å¢åˆ†ç»„</a></div>'+
			               '<div class="item-tools mt5"><span class="ttips">å¤‡æ³¨ï¼š</span><input class="input" type="text"/></div>'+
			               '<div class="tools-view"><a class="cancel">å–æ¶ˆ</a><a class="done">ç¡®å®š</a></div></div></div>';
			   $("#message-grade").append(first);
		   }
		   if(isFriend==1){ //æˆ‘ç”³è¯·åŠ åˆ«äººä¸ºå¥½å‹
			   var second = '<div class="message-item">'+
			                '<span class="tips">'+last_time+'</span>'+
			                '<div class="message-type-1" id="'+id+'">'+
			                '<img class="user-icon" src="../images/order_test.png">'+
			                '<div class="user-info">'+
			                '<span class="tips">'+author+' ('+authorMobile+')æ‚¨çš„ç”³è¯·å·²å‘å‡ºï¼</span>'+
			                '<div class="cell mt10"><span class="sub-tips">ç”¨æˆ·ä¿¡ç”¨:</span><img class="star-img" src="../images/star.png"><img class="star-img" src="../images/star.png"><img class="star-img" src="../images/star.png"><img class="star-img" src="../images/star.png"><img class="star-img" src="../images/half_star.png"><span class="score-tips">4.9åˆ†</span></div>'+
			                '<div class="cell"><span class="sub-tips">å•†å®¶ç­‰çº§:</span><img class="shop-level-icon" src="../images/shop_level_icon.png"><span class="level-tips"> 5 Lev</span></div>'+
			                '</div><a class="tools-btn b6BC2EF">ç­‰å¾…å¯¹æ–¹éªŒè¯</a></div></div>';
			   $("#message-grade").append(second);
		   }
		   if(isFriend==0){ //å·²ç»æˆä¸ºå¥½å‹
			   addSuccess(last_time,author,authorMobile,id);
		   }
	   }
	   
	    //ä¿¡æ¯åˆ—è¡¨ æ·»åŠ å¥½å‹
	    $(".add-friend").click(function(){
	      $($(this).parent()).animate({height:"250px"});
	      $(this).hide();
	      var data = {"userId":sellId};
	      doPost("/huoban-sales/http/sales/userlogin//myFriendGroup.do",data,infoListSuccess);
	    });

	    $(".cancel").click(function(){
	      $($(this).parent().parent().parent()).animate({height:"114px"});
	      $($(this).parent().parent()).siblings(".add-friend").show();
	    });

   }
    
   //å·¦ä¾§menu  0 æœ€è¿‘è”ç³»äºº 1 å¥½å‹åˆ—è¡¨ 2 ç¾¤ç»„åˆ—è¡¨
   function changeLeftTab(index){
	   var data = {"uid":sellId};
	   imIndex = index;
	   if(imIndex==0){
		   doPost("/huoban-sales/http/sales/userlogin/newFriend.do",data,newFriendListSuccess);
	   }
	   if(imIndex==1){
		   var data = {"userId":sellId};
		   doPost("/huoban-sales/http/sales/userlogin/myFriendGroup.do",data,friendListSuccess);
	   }
	   if(imIndex==2){
		   doPost("/huoban-sales/http/sales/userlogin/userFriend.do",data,contactsSuccess);
	   }
   }
   //ç‚¹å‡»enteré”®å‘é€æ¶ˆæ¯
   $(document).keydown(function (event) {
	   if (event.keyCode == 13) {
		   $("#sendMessage").click();
	   }
	});
   

   $("#sendMessage").click(function(){
	   if(imIndex==1){ //ç§èŠ
		   //å‘é€æ–‡å­—æ¶ˆæ¯
		   var im_text = $("#im_text").val();
		   //å®šä¹‰æ¶ˆæ¯ç±»å‹,æ–‡å­—æ¶ˆæ¯ä½¿ç”¨ RongIMLib.TextMessage
		   var msg = new RongIMLib.TextMessage({content:im_text,extra:"é™„åŠ ä¿¡æ¯"});
		   //æˆ–è€…ä½¿ç”¨RongIMLib.TextMessage.obtain æ–¹æ³•.å…·ä½“ä½¿ç”¨è¯·å‚è§æ–‡æ¡£  //var msg = RongIMLib.TextMessage.obtain("hello"); 
		   var conversationtype = RongIMLib.ConversationType.PRIVATE; // ç§èŠ
		   var targetId = toUserId; // ç›®æ ‡ Id
		   if(targetId==undefined || targetId==null){
			   alert("è¯·é€‰æ‹©å¥½å‹");
			   return;
		   }
		   RongIMClient.getInstance().sendMessage(conversationtype, targetId, msg, {
			   // å‘é€æ¶ˆæ¯æˆåŠŸ
			   onSuccess: function (message) {
				   //message ä¸ºå‘é€çš„æ¶ˆæ¯å¯¹è±¡å¹¶ä¸”åŒ…å«æœåŠ¡å™¨è¿”å›çš„æ¶ˆæ¯å”¯ä¸€Idå’Œå‘é€æ¶ˆæ¯æ—¶é—´æˆ³
				   console.log("å‘é€æˆåŠŸï¼");
				   $("#im_text").val("");
				   //è·å–å†…å®¹
				   var content = message.content.content;
				   if(content==null || content== ""){
					   return;
				   }
				   //è·å–å‘é€æ—¶é—´ 
				   var date = new Date();
				   var now = (new Date()).Format("yyyy-MM-dd hh:mm:ss");
				   var hour = now.substring(11,13); //å‘é€æ¶ˆæ¯çš„å°æ—¶
				   var fen = now.substring(14,16);  //å‘é€æ¶ˆæ¯çš„åˆ†é’Ÿ
				  
				   //è·å–æ¶ˆæ¯å”¯ä¸€çš„id
				   var messageId = message.messageId;
				   var contentList = '<div class="my-chat">'+
									 '<div class="my-chat-info">'+
									 '<pre>'+content+'</pre>'+
									 '</div>'+
									 '<span class="right-arrow"></span>'+
									 '<img class="user-icon" src="../images/im-user-icon.png">'+
									 '</div>';
				   $("#chat-list").append(contentList);
				   
				   
				   //è®©æ»šåŠ¨æ»‘åˆ°æœ€åº•ä¸‹
				   var height = $("#chat-list")[0].scrollHeight; 
				   $("#chat-list").perfectScrollbar('update');
				   $("#chat-list").scrollTop(height);
				   
				   setMap(targetId);//ä¿å­˜åˆ°å†å²æ¶ˆæ¯è®°å½•ä¸­
			   },
			   onError: function (errorCode,message) {
				   var info = '';
				   switch (errorCode) {
				   case RongIMLib.ErrorCode.TIMEOUT:
					   info = 'è¶…æ—¶';
					   break;
				   case RongIMLib.ErrorCode.UNKNOWN_ERROR:
					   info = 'æœªçŸ¥é”™è¯¯';
					   break;
				   case RongIMLib.ErrorCode.REJECTED_BY_BLACKLIST:
					   info = 'åœ¨é»‘åå•ä¸­ï¼Œæ— æ³•å‘å¯¹æ–¹å‘é€æ¶ˆæ¯';
					   break;
				   case RongIMLib.ErrorCode.NOT_IN_DISCUSSION:
					   info = 'ä¸åœ¨è®¨è®ºç»„ä¸­';
					   break;
				   case RongIMLib.ErrorCode.NOT_IN_GROUP:
					   info = 'ä¸åœ¨ç¾¤ç»„ä¸­';
					   break;
				   case RongIMLib.ErrorCode.NOT_IN_CHATROOM:
					   info = 'ä¸åœ¨èŠå¤©å®¤ä¸­';
					   break;
				   default :
					   info = x;
				   break;
				   }
				   console.log('å‘é€å¤±è´¥:' + info);
			   }
		   });
	   }
	   if(imIndex==2){	//ç¾¤èŠ  
		   //æ–‡æœ¬æ¶ˆæ¯
		   var im_text = $("#im_text").val();
		   var msg = new RongIMLib.TextMessage({content:im_text,extra:"é™„åŠ ä¿¡æ¯"});
		   var conversationtype = RongIMLib.ConversationType.GROUP; // ç¾¤èŠ
		   var targetId = groupId;
		   if(targetId==undefined || targetId==null){
			   alert("è¯·é€‰æ‹©ç¾¤ç»„");
			   return;
		   }
		   RongIMClient.getInstance().sendMessage(conversationtype, targetId, msg, {
	           // å‘é€æ¶ˆæ¯æˆåŠŸ
	           onSuccess: function (message) {
	               //message ä¸ºå‘é€çš„æ¶ˆæ¯å¯¹è±¡å¹¶ä¸”åŒ…å«æœåŠ¡å™¨è¿”å›çš„æ¶ˆæ¯å”¯ä¸€Idå’Œå‘é€æ¶ˆæ¯æ—¶é—´æˆ³
				   console.log("å‘é€æˆåŠŸï¼");
				   $("#im_text").val("");
				   //è·å–å†…å®¹
				   var content = message.content.content;
				   if(content==null || content== ""){
					   return;
				   }
				   //è·å–å‘é€æ—¶é—´
				   var sendTime = message.sentTime;
				   //è·å–æ¶ˆæ¯å”¯ä¸€çš„id
				   var messageId = message.messageId;
				   var contentList = '<div class="my-chat">'+
									 '<div class="my-chat-info">'+
									 '<pre>'+content+'</pre>'+
									 '</div>'+
									 '<span class="right-arrow"></span>'+
									 '<img class="user-icon" src="../images/im-user-icon.png">'+
									 '</div>';
				   $("#chat-list").append(contentList);
				   
				   //è®©æ»šåŠ¨æ»‘åˆ°æœ€åº•ä¸‹
				   var height = $("#chat-list")[0].scrollHeight; 
				   $("#chat-list").perfectScrollbar('update');
				   $("#chat-list").scrollTop(height);
				   
				   setMap(targetId);//ä¿å­˜åˆ°å†å²æ¶ˆæ¯è®°å½•ä¸­
	           },
	           onError: function (errorCode,message) {
	               var info = '';
	               switch (errorCode) {
	                   case RongIMLib.ErrorCode.TIMEOUT:
	                       info = 'è¶…æ—¶';
	                       break;
	                   case RongIMLib.ErrorCode.UNKNOWN_ERROR:
	                       info = 'æœªçŸ¥é”™è¯¯';
	                       break;
	                   case RongIMLib.ErrorCode.REJECTED_BY_BLACKLIST:
	                       info = 'åœ¨é»‘åå•ä¸­ï¼Œæ— æ³•å‘å¯¹æ–¹å‘é€æ¶ˆæ¯';
	                       break;
	                   case RongIMLib.ErrorCode.NOT_IN_DISCUSSION:
	                       info = 'ä¸åœ¨è®¨è®ºç»„ä¸­';
	                       break;
	                   case RongIMLib.ErrorCode.NOT_IN_GROUP:
	                       info = 'ä¸åœ¨ç¾¤ç»„ä¸­';
	                       break;
	                   case RongIMLib.ErrorCode.NOT_IN_CHATROOM:
	                       info = 'ä¸åœ¨èŠå¤©å®¤ä¸­';
	                       break;
	                   default :
	                       info = x;
	                       break;
	               }
	               alert('å‘é€å¤±è´¥:' + info);
	           }
	       });
		   }
   });
       
     //ç‚¹å‡»æŸ¥çœ‹æ›´å¤šæ¶ˆæ¯
     $("#all-chat").click(function(){
    	 $("#chat-list").scrollTop(0);
     });
     
	 $("#biaoqing").click(function(){
		
		//ä½¿ç”¨é»˜è®¤ Emoji å’Œå›¾ç‰‡
		RongIMLib.RongIMEmoji.init();
		
		//è·å–å…¨éƒ¨è¡¨æƒ…
		var emojis = RongIMLib.RongIMEmoji.emojis;

		for(var i = 0;i<emojis.length;i++){
			var bq = emojis[i].children[0];
			var $bq = $(bq).attr("name");
			//åç§°è½¬åŒ–ä¸ºè¡¨æƒ…
			var str = RongIMLib.RongIMEmoji.symbolToEmoji($bq);
			console.log(str);
		}
		
//		//åç§°è½¬ Emoji
//		//å‘é€æ¶ˆæ¯ä½¿ç”¨(è¡¨æƒ…)
//		var str = RongIMLib.RongIMEmoji.symbolToEmoji("[ç‹ç¬‘][éœ²é½¿è€Œç¬‘]æµ‹è¯•Emoji");
//		
//		//Emoji è½¬åç§°
//		//ä¼šè¯åˆ—è¡¨æ˜¾ç¤ºæœ€åä¸€æ¡æ¶ˆæ¯ä½¿ç”¨(è¡¨æƒ…è½¬æˆå¯¹åº”çš„å­—)
//		var str1 = RongIMLib.RongIMEmoji.emojiToSymbol("ğŸ˜€ğŸ˜æµ‹è¯• Emoji");
//		
//		//Emoji è½¬å­— HTML
//		//æ¥æ”¶æ¶ˆæ¯ä½¿ç”¨(htmlä»£ç )
//		var str2 = RongIMLib.RongIMEmoji.emojiToHTML("ğŸ˜‚æµ‹è¯• Emoji");
//		
//		//åç§°è½¬å­— HTML(htmlä»£ç )
//		var str3 = RongIMLib.RongIMEmoji.symbolToHTML("[éœ²é½¿è€Œç¬‘]æµ‹è¯• Emoji");
		
	});
	  
	 //å°è£…å¥½å‹åˆ†ç»„åˆ—è¡¨
	 function friendGroup(result){
		  if(result!=null){
			  for(var i=0;i<result.length;i++){
				 var groupId = result[i].groupId;
				 var groupName = result[i].groupName;
				 var content = '<option value="'+groupId+'">'+groupName+'</option>';
				 $(".select").append(content);
			  }
		  }
	 }
	 
	  //å¥½å‹åˆ†ç»„æŸ¥è¯¢æˆåŠŸå›è°ƒå‡½æ•°
	  var friendGroupSuccess = function(datas){
		  $(".select").empty();
		  var result = datas.data;
		  friendGroup(result);
	  }
	 
	 
	  //æ ¹æ®æ¡ä»¶æŸ¥è¯¢å¥½å‹æˆåŠŸå›è°ƒå‡½æ•°
	  var  searchFriendSuccess = function(datas){
		  $("#result-list").empty();
		  var result = datas.data;
		  var length = result.length;
		  changeContentHeight(length);
		  for(var i=0;i<result.length;i++){
			  var id = result[i].id;
			  var isFriend = result[i].isFriend;
			  var author = result[i].author;
			  var authorMobile = result[i].authorMobile;
			  if(isFriend!=0){
				  var content = '<div class="result-item">'+
								'<img src="../images/order_test.png" class="user-icon">'+
								'<div class="info-view">'+
								'<span class="user-name">'+author+'('+authorMobile+')</span>'+
								'<div class="cell mt8">'+
								'<span class="title">ç”¨æˆ·ä¿¡ç”¨:</span>'+
								'<div class="star-list">'+
								'<img src="../images/star.png">'+
								'<img src="../images/star.png">'+
								'<img src="../images/star.png">'+
								'<img src="../images/star.png">'+
								'<img src="../images/half_star.png">'+
								'<span class="score">4.9åˆ†</span>'+
								'</div></div>'+
								'<div class="cell mt2">'+
								'<span class="title">å•†å®¶ç­‰çº§:</span>'+
								'<img class="shop_icon" src="../images/shop_level_icon.png">'+
								'<span class="subtitle"> 7 Lev</span></div></div>'+
								'<div class="tools-view" name="'+id+'">'+
								'<a class="add-btn">åŠ ä¸ºå¥½å‹</a>'+
								'</div></div>';
				  $("#result-list").append(content);
			  }
		  }
		  
			 //åŠ ä¸ºå¥½å‹
			 $(".add-btn").click(function(){
			     $("#search_friend_dialog").modal('hide');
			     $("#add_friend_dialog").modal('show');
				 friendId = $(this).parent().attr("name");
				 var data = {"userId":sellId};
				 doPost("/huoban-sales/http/sales/userlogin/myFriendGroup.do",data,friendGroupSuccess);
			 });
	  }
 
	 //æ ¹æ®æ¡ä»¶æŸ¥è¯¢å¥½å‹
	 $("#search-btn").click(function(){
		 var accountNo = $("#search-input").val();
		 var data = {"pro":accountNo,"uid":sellId};
		 doPost("/huoban-sales/http/sales/userlogin/searchPerson.do",data,searchFriendSuccess);
	 });
	 
	 var addFriendSuccess = function(datas){
         var result = datas.message;
         alert(result);
		 $("#add_friend_dialog").modal('hide');
	 }
	 
	 //ç‚¹å‡»å‘é€æŒ‰é’®æ·»åŠ å¥½å‹
	 $("#add-friend").click(function(){
		 var option = $(".select").val();
		 if(option==null || option==undefined){
			 option=0;
		 }
		 var remark = $("#remark").val();
		 var data = {"userId":sellId,"groupId":option,"label":remark,"friendId":friendId};
		 doPost("/huoban-sales/http/sales/userlogin/addFriend.do",data,addFriendSuccess);
	 });
     
	 //ç‚¹å‡»å–æ¶ˆæŒ‰é’®
	 $("#cancle").click(function(){
		 $("#add_friend_dialog").modal('hide');
	 });
	 

	 //åˆ›å»ºå¥½å‹åˆ†ç»„æˆåŠŸå›è°ƒå‡½æ•°
	 var createFriendSuccess = function(datas){
		 var result = datas.message;
		 alert(result);
		 $("#add_group_dialog").modal('hide');
	 }
	 
	 //åˆ›å»ºå¥½å‹åˆ†ç»„
	 $("#add-group").click(function(){
		 var groupName = $("#group-name").val();
//		 if(!Utils.checkNotEmpty(groupName)){
//			 alert("åˆ†ç»„åç§°ä¸èƒ½ä¸ºç©º");
//		 }
		 var data = {"userId":sellId,"groupName":groupName};
		 doPost("/huoban-sales/http/sales/userlogin/addFriendGroup.do",data,createFriendSuccess);
	 });
	 
	 
	  //å°è£…åˆ›å»ºè®¨è®ºç»„ å‹¾é€‰æœ‹å‹
	  function selectFriend(){
		    var record = [];
		    $(".user-checkbox").click(function(){
		      if($(this).get(0).checked==true){
		        var a=($($(this).parent()).siblings(".check-box-info").html());
		        var b='<div class="checked-user-item" id='+$(this).attr('data-uid')+'>'+a+'</div>';
		        var length = $("#checked-user-list").children().length;
		        console.log(length);
		        if(length==0){
		        	$("#checked-user-list").append(b);
		        }else{
		        	for(var i=0;i<length;i++){
		        		var id = $("#checked-user-list").children()[i].id;
		        		record.push(id);
		        	}
		        	var dataUid = $(this).attr("data-uid");
		        	if(jQuery.inArray(dataUid,record)==-1){
		        	    $("#checked-user-list").append(b);
		        	}
		        }
		        $(".checked-user-item").unbind().bind('click',function(){
		          var cb=$('input:checkbox[data-uid='+$(this).attr("id")+']:checked');
		          $(cb).removeAttr('checked');
		          $(this).remove();
		 
		        });
		      }else{
		        $('#'+$(this).attr('data-uid')).remove();
		      }
		    });
	  }
	 
	 //æŸ¥è¯¢æ¯ä¸ªåˆ†ç»„ä¸‹çš„å¥½å‹æˆåŠŸå›è°ƒå‡½æ•°
	 var everyFriendSuccess = function(datas){
		 $("#center-group-view").empty();
		 var result = datas.data;
		 if(result!=null){
			 for(var i=0;i<result.length;i++){
				 var author = result[i].author;
				 var authorMobile = result[i].authorMobile;
				 var sellId = result[i].id;
				 var content = '<div class="user-list">'+
							   '<div class="user-item">'+
							   '<div class="rg_cb">'+
							   '<input class="user-checkbox" type="checkbox" data-uid="sellId'+sellId+'" value="" id="user-checkbox-1+'+i+'" name="jy" />'+
							   '<label for="user-checkbox-1'+i+'"></label></div>'+
							   '<label class="check-box-info" for="user-checkbox-1">'+
							   '<img class="user-icon" src="../images/order_test.png">'+
							   '<span class="user-name">'+author+'ï¼ˆ'+authorMobile+'ï¼‰</span>'+
							   '</label></div></div>';
				 $("#center-group-view").append(content);
			 }
		 }
		    //åˆ›å»ºè®¨è®ºç»„ å‹¾é€‰æœ‹å‹
		    selectFriend();
	 }
	 
	 
	 //æŸ¥è¯¢å¥½å‹åˆ†ç»„
	 var createGroupSuccess = function(datas){
		 $("#center-group-view").empty();
		 $("#checked-user-list").empty();
		 var result = datas.data;
		 var length = result.length;
		 var first = '<div class="menu-view">'+
					 '<a class="menu-tips" data-toggle="collapse" data-parent="#accordion" href="#collapse-friend">'+
					 'ä¼™ä¼´åˆ†ç»„ï¼ˆ'+length+'ï¼‰'+
					 '</a>'+
					 '<img class="arrow-img" src="../images/im_arrow_up.png"></div>'+
					 '<div id="collapse-friend" class="panel-collapse collapse in">'+
					 '<div class="friend-list">'+
					 '</div></div>';
		 $("#left-group-view").prepend(first);
		 for(var i=0;i<result.length;i++){
			 var groupName = result[i].groupName;
			 var id = result[i].groupId;
			 var second = '<a class="friend-item" id="'+id+'">'+groupName+'</a>';
			 $(".friend-list").append(second);
		 }
		 
		 
		 //ç‚¹å‡»åˆ†ç»„æŸ¥è¯¢è¯¥ç»„å¥½å‹
		 $(".friend-item").click(function(){
			 var groupId = $(this).attr("id");
			 var data = {"userId":sellId,"gid":groupId};
			 doPost("/huoban-sales/http/sales/userlogin/myGroup_Friend.do",data,everyFriendSuccess);
		 });
	 }
	 
	 //æ ¹æ®groupIdæŸ¥è¯¢ç¾¤æˆå‘˜
	 var groupMemberSuccess = function(datas){
		 $("#center-group-view").empty();
		 var result = datas.data;
		 var groupList = result.lsi;
		 for(var i=0;i<groupList.length;i++){
			 var author = groupList[i].author;
			 var authorMobile = groupList[i].authorMobile;
			 var sellId = groupList[i].id;
			 var content = '<div class="user-list">'+
						   '<div class="user-item">'+
						   '<div class="rg_cb">'+
						   '<input class="user-checkbox" type="checkbox" data-uid="sellId'+sellId+'" value="" id="user-checkbox-1'+i+'" name="jy" />'+
						   '<label for="user-checkbox-1'+i+'"></label></div>'+
						   '<label class="check-box-info" for="user-checkbox-1">'+
						   '<img class="user-icon" src="../images/order_test.png">'+
						   '<span class="user-name">'+author+'ï¼ˆ'+authorMobile+'ï¼‰</span>'+
						   '</label></div></div>';
            $("#center-group-view").append(content);
		 }
		    
		    //åˆ›å»ºè®¨è®ºç»„ å‹¾é€‰æœ‹å‹
		    selectFriend();
		   	    
	 }
	 
	 //åˆ›å»ºç¾¤ç»„
	 $("#create-group").click(function(){
	     $("#left-group-view").empty();
	     changeLeftTab(2);
		 var length = groupList.length;
		 var first = '<div class="menu-view">'+
					 '<a class="menu-tips" data-toggle="collapse" data-parent="#accordion"href="#collapse-group">'+
					 'ä¼™ä¼´è®¨è®ºç»„ï¼ˆ'+length+'ï¼‰'+
					 '</a>'+
					 '<img class="arrow-img" src="../images/im_arrow_down.png"></div>'+
					 '<div id="collapse-group" class="panel-collapse collapse in">'+
					 '<div class="group-list">'+
					 '</div></div>';
		 $("#left-group-view").append(first);
		 
		 for(var i=0;i<groupList.length;i++){
			 var groupName = groupList[i].groupName;
			 var groupId = groupList[i].groupId;
			 var second = '<a class="group-item" id="'+groupId+'">'+
			 '<img class="group-img" src="../images/order_test.png">'+
			 '<span class="group-tips">'+groupName+'</span></a>';
			 $(".group-list").append(second);
		 }
		 
		 var data = {"userId":sellId};
		 doPost("/huoban-sales/http/sales/userlogin/myFriendGroup.do",data,createGroupSuccess);

		 
		 //æ ¹æ®groupIdæŸ¥è¯¢è¯¥ç¾¤æˆå‘˜
	     $(".group-item").click(function(){
	    	 var group_id = $(this).attr("id");
	    	 var data = {"group_id":group_id};
	    	 doPost("/huoban-sales/http/sales/userlogin/groupById.do",data,groupMemberSuccess);
	     });
	 });

	 
	 //æ ¹æ®æ¡ä»¶æŸ¥è¯¢å¥½å‹æˆåŠŸå›è°ƒå‡½æ•°
	 var searchPersonSuccess = function(datas){
		 var result = datas.data;
		 $("#center-group-view").empty();
		 //$("#checked-user-list").empty();
		 for(var i=0;i<result.length;i++){
			 var author = result[i].author;
			 var authorMobile = result[i].authorMobile;
			 var sellId = result[i].id;
			 var content = '<div class="user-list">'+
						   '<div class="user-item">'+
						   '<div class="rg_cb">'+
						   '<input class="user-checkbox" type="checkbox" data-uid="sellId'+sellId+'" value="" id="user-checkbox-1'+i+'" name="jy" />'+
						   '<label for="user-checkbox-1'+i+'"></label></div>'+
						   '<label class="check-box-info" for="user-checkbox-1">'+
						   '<img class="user-icon" src="../images/order_test.png">'+
						   '<span class="user-name">'+author+'ï¼ˆ'+authorMobile+'ï¼‰</span>'+
						   '</label></div></div>';
            $("#center-group-view").append(content);
		 }
		    //åˆ›å»ºè®¨è®ºç»„ å‹¾é€‰æœ‹å‹
		    selectFriend();   
	 }
	 
	 
	 //åˆ›å»ºè®¨è®ºç»„ä¸­çš„æœç´¢
	 $("#search-friend").click(function(){
		 var input = $("#search-input").val();
		 var data = {"pro":input,"uid":sellId};
		 doPost("/huoban-sales/http/sales/userlogin/searchPerson.do",data,searchPersonSuccess);
	 });

	 changeLeftTab(1);
})
